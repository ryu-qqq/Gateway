# AWS Distro for OpenTelemetry (ADOT) Collector Configuration
# Service: gateway (port 8080)
# Updated for ADOT v0.46.0
# Fixed: out of order sample error by adding unique instance identification

receivers:
  otlp:
    protocols:
      grpc:
        endpoint: 0.0.0.0:4317
      http:
        endpoint: 0.0.0.0:4318

  prometheus:
    config:
      global:
        scrape_interval: 30s
        scrape_timeout: 10s

      scrape_configs:
        - job_name: 'gateway-metrics'
          scrape_interval: 30s
          static_configs:
            - targets: ['localhost:8080']
          metrics_path: /actuator/prometheus
          metric_relabel_configs:
            # 필요한 메트릭만 수집
            - source_labels: [__name__]
              regex: '(http_.*|jvm_.*|process_.*|system_.*|application_.*|spring_.*|gateway_.*)'
              action: keep
            # instance 레이블을 ECS task ID로 교체 (중복 방지)
            - source_labels: [aws_ecs_task_id]
              target_label: instance
              regex: (.+)
              replacement: $1
              action: replace

  awsecscontainermetrics:
    collection_interval: 30s

processors:
  batch:
    timeout: 60s
    send_batch_size: 1000

  memory_limiter:
    check_interval: 5s
    limit_mib: 410
    spike_limit_mib: 128

  # ECS 태스크 메타데이터 자동 감지 - 각 태스크별 고유 식별자 부여
  resourcedetection:
    detectors: [env, ecs]
    timeout: 5s
    override: true
    ecs:
      resource_attributes:
        aws.ecs.task.arn:
          enabled: true
        aws.ecs.cluster.arn:
          enabled: true
        aws.ecs.task.id:
          enabled: true
        cloud.availability_zone:
          enabled: true

  resource:
    attributes:
      - key: environment
        value: ${ENVIRONMENT}
        action: upsert
      - key: cluster_name
        value: ${CLUSTER_NAME}
        action: upsert
      - key: service_name
        value: gateway
        action: upsert

  # 메트릭 레이블 변환
  # Note: resourcedetection이 aws.ecs.task.id를 추가하고
  # resource_to_telemetry_conversion: true가 이를 메트릭 레이블로 변환
  # 이렇게 하면 각 ECS 태스크별로 고유한 시계열이 생성됨
  metricstransform:
    transforms:
      - include: ".*"
        match_type: regexp
        action: update
        operations:
          - action: add_label
            new_label: service
            new_value: gateway

exporters:
  awsxray:
    region: ${AWS_REGION}
    indexed_attributes:
      - http.method
      - http.status_code
      - http.route
      - rpc.service
      - rpc.method

  prometheusremotewrite:
    endpoint: ${AMP_ENDPOINT}
    auth:
      authenticator: sigv4auth
    resource_to_telemetry_conversion:
      enabled: true
    retry_on_failure:
      enabled: true
      initial_interval: 5s
      max_interval: 30s
      max_elapsed_time: 300s

extensions:
  sigv4auth:
    region: ${AWS_REGION}
    service: aps

  health_check:
    endpoint: :13133

service:
  extensions:
    - sigv4auth
    - health_check

  telemetry:
    logs:
      level: warn
      encoding: json
    metrics:
      level: detailed

  pipelines:
    metrics:
      receivers:
        - otlp
        - prometheus
        - awsecscontainermetrics
      processors:
        - memory_limiter
        - resourcedetection  # ECS 태스크 메타데이터 먼저 감지
        - resource
        - metricstransform
        - batch
      exporters:
        - prometheusremotewrite

    traces:
      receivers:
        - otlp
      processors:
        - memory_limiter
        - resourcedetection  # ECS 태스크 메타데이터 먼저 감지
        - resource
        - batch
      exporters:
        - awsxray
