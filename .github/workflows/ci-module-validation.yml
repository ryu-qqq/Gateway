name: CI - Module Validation (Gradual Rollout)

on:
  pull_request:
    branches:
      - main
      - develop
    paths:
      - 'domain/**'
      - 'application/**'
      - 'adapter-in/**'
      - 'adapter-out/**'
      - 'bootstrap/**'
  workflow_dispatch:
    inputs:
      module:
        description: 'Module to validate (domain, application, adapter-in:gateway, etc.)'
        required: true
        type: choice
        options:
          - all
          - domain
          - application
          - adapter-in:gateway
          - adapter-out:persistence-redis
          - adapter-out:authhub-client
          - bootstrap:bootstrap-gateway

jobs:
  # ========================================
  # Detect Changed Modules
  # ========================================
  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      domain: ${{ steps.filter.outputs.domain }}
      application: ${{ steps.filter.outputs.application }}
      adapter-in-gateway: ${{ steps.filter.outputs.adapter-in-gateway }}
      adapter-out-redis: ${{ steps.filter.outputs.adapter-out-redis }}
      adapter-out-authhub: ${{ steps.filter.outputs.adapter-out-authhub }}
      bootstrap-gateway: ${{ steps.filter.outputs.bootstrap-gateway }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect module changes
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            domain:
              - 'domain/**'
            application:
              - 'application/**'
            adapter-in-gateway:
              - 'adapter-in/gateway/**'
            adapter-out-redis:
              - 'adapter-out/persistence-redis/**'
            adapter-out-authhub:
              - 'adapter-out/authhub-client/**'
            bootstrap-gateway:
              - 'bootstrap/bootstrap-gateway/**'

  # ========================================
  # Validate Domain Module
  # ========================================
  validate-domain:
    name: Validate Domain Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.domain == 'true' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.module == 'domain' || github.event.inputs.module == 'all')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Domain Module
        run: ./gradlew :domain:build

      - name: Test Domain Module
        run: ./gradlew :domain:test

      - name: Domain Module Summary
        if: success()
        run: |
          echo "✅ Domain Module Validation PASSED"
          echo "  - Build: Success"
          echo "  - Tests: Success"

  # ========================================
  # Validate Application Module
  # ========================================
  validate-application:
    name: Validate Application Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.application == 'true' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.module == 'application' || github.event.inputs.module == 'all')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Application Module
        run: ./gradlew :application:build

      - name: Test Application Module
        run: ./gradlew :application:test

      - name: Application Module Summary
        if: success()
        run: |
          echo "✅ Application Module Validation PASSED"
          echo "  - Build: Success"
          echo "  - Tests: Success"

  # ========================================
  # Validate Adapter-In (Gateway) Module
  # ========================================
  validate-adapter-in-gateway:
    name: Validate Gateway Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.adapter-in-gateway == 'true' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.module == 'adapter-in:gateway' || github.event.inputs.module == 'all')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Gateway Module
        run: ./gradlew :adapter-in:gateway:build

      - name: Test Gateway Module
        run: ./gradlew :adapter-in:gateway:test

      - name: Gateway Module Summary
        if: success()
        run: |
          echo "✅ Gateway Module Validation PASSED"
          echo "  - Build: Success"
          echo "  - Tests: Success"

  # ========================================
  # Validate Adapter-Out (Redis) Module
  # ========================================
  validate-adapter-out-redis:
    name: Validate Persistence Redis Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.adapter-out-redis == 'true' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.module == 'adapter-out:persistence-redis' || github.event.inputs.module == 'all')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Persistence Redis Module
        run: ./gradlew :adapter-out:persistence-redis:build

      - name: Test Persistence Redis Module
        run: ./gradlew :adapter-out:persistence-redis:test

      - name: Persistence Redis Module Summary
        if: success()
        run: |
          echo "✅ Persistence Redis Module Validation PASSED"
          echo "  - Build: Success"
          echo "  - Tests: Success"

  # ========================================
  # Validate Adapter-Out (AuthHub Client) Module
  # ========================================
  validate-adapter-out-authhub:
    name: Validate AuthHub Client Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.adapter-out-authhub == 'true' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.module == 'adapter-out:authhub-client' || github.event.inputs.module == 'all')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build AuthHub Client Module
        run: ./gradlew :adapter-out:authhub-client:build

      - name: Test AuthHub Client Module
        run: ./gradlew :adapter-out:authhub-client:test

      - name: AuthHub Client Module Summary
        if: success()
        run: |
          echo "✅ AuthHub Client Module Validation PASSED"
          echo "  - Build: Success"
          echo "  - Tests: Success"

  # ========================================
  # Validate Bootstrap (Gateway) Module
  # ========================================
  validate-bootstrap-gateway:
    name: Validate Bootstrap Gateway Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      needs.detect-changes.outputs.bootstrap-gateway == 'true' ||
      github.event_name == 'workflow_dispatch' &&
      (github.event.inputs.module == 'bootstrap:bootstrap-gateway' || github.event.inputs.module == 'all')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Bootstrap Gateway Module
        run: ./gradlew :bootstrap:bootstrap-gateway:build

      - name: Test Bootstrap Gateway Module
        run: ./gradlew :bootstrap:bootstrap-gateway:test

      - name: Bootstrap Gateway Module Summary
        if: success()
        run: |
          echo "✅ Bootstrap Gateway Module Validation PASSED"
          echo "  - Build: Success"
          echo "  - Tests: Success"

  # ========================================
  # Validation Summary
  # ========================================
  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs:
      - detect-changes
      - validate-domain
      - validate-application
      - validate-adapter-in-gateway
      - validate-adapter-out-redis
      - validate-adapter-out-authhub
      - validate-bootstrap-gateway
    if: always()

    steps:
      - name: Summary
        run: |
          echo "========================================="
          echo "Module Validation Summary"
          echo "========================================="
          echo "Domain: ${{ needs.validate-domain.result || 'skipped' }}"
          echo "Application: ${{ needs.validate-application.result || 'skipped' }}"
          echo "Gateway: ${{ needs.validate-adapter-in-gateway.result || 'skipped' }}"
          echo "Persistence Redis: ${{ needs.validate-adapter-out-redis.result || 'skipped' }}"
          echo "AuthHub Client: ${{ needs.validate-adapter-out-authhub.result || 'skipped' }}"
          echo "Bootstrap Gateway: ${{ needs.validate-bootstrap-gateway.result || 'skipped' }}"
          echo "========================================="

          # Check if any validation failed
          if [[ "${{ needs.validate-domain.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-application.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-adapter-in-gateway.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-adapter-out-redis.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-adapter-out-authhub.result }}" == "failure" ]] || \
             [[ "${{ needs.validate-bootstrap-gateway.result }}" == "failure" ]]; then
            echo "❌ Module Validation FAILED"
            exit 1
          else
            echo "✅ All changed modules passed validation"
          fi
