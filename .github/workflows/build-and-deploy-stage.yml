# ============================================================================
# Connectly Gateway Build & Deploy - STAGE
#
# Stage 환경 전용 배포 워크플로우
# stage 브랜치 push 또는 수동 트리거
# ============================================================================

name: Build and Deploy to ECS (Stage)

on:
  workflow_dispatch: # 수동 트리거 허용
  push:
    branches:
      - stage
    paths-ignore:
      - 'terraform/**'
      - '.github/workflows/terraform-*.yml'
      - '**.md'
      - 'docs/**'

permissions:
  contents: read
  id-token: write

env:
  AWS_REGION: ap-northeast-2
  ECS_CLUSTER: gateway-cluster-stage

jobs:
  # ============================================================================
  # 테스트 (공통 - 한 번만 실행)
  # ============================================================================
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Run tests
        run: |
          chmod +x gradlew
          ./gradlew clean test \
            -x jacocoTestCoverageVerification \
            -x :integration-test:test \
            -x :adapter-out:persistence-redis:test \
            --no-daemon

  # ============================================================================
  # 빌드 Job
  # ============================================================================
  build-gateway:
    name: Build gateway
    needs: test
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-build-docker.yml@main
    with:
      ecr-repository: gateway-stage
      component: gateway
      dockerfile: bootstrap/bootstrap-gateway/Dockerfile
      gradle-task: ":bootstrap:bootstrap-gateway:bootJar"
      timeout-minutes: 30
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

  # ============================================================================
  # 배포 Job
  # ============================================================================
  deploy-gateway:
    name: Deploy gateway
    needs: build-gateway
    uses: ryu-qqq/Infrastructure/.github/workflows/reusable-deploy-ecs.yml@main
    with:
      ecs-cluster: gateway-cluster-stage
      ecs-service: gateway-stage
      image-uri: ${{ needs.build-gateway.outputs.image-uri }}
    secrets:
      AWS_ROLE_ARN: ${{ secrets.AWS_ROLE_ARN }}

