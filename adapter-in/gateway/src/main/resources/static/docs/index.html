<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.18">
<title>Connectly Gateway Documentation</title>
<link rel="stylesheet" href="./custom-style.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/styles/github.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Connectly Gateway Documentation</h1>
<div class="details">
<span id="revnumber">version 1.0.0-SNAPSHOT</span>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#overview">1. 개요</a>
<ul class="sectlevel2">
<li><a href="#_핵심_기능">1.1. 핵심 기능</a></li>
</ul>
</li>
<li><a href="#architecture">2. 아키텍처</a>
<ul class="sectlevel2">
<li><a href="#architecture-overview">2.1. 시스템 개요</a></li>
<li><a href="#architecture-filter-chain">2.2. Filter Chain</a>
<ul class="sectlevel3">
<li><a href="#_filter_실행_순서">2.2.1. Filter 실행 순서</a></li>
<li><a href="#_filter_동작_흐름">2.2.2. Filter 동작 흐름</a></li>
</ul>
</li>
<li><a href="#architecture-external-dependencies">2.3. 외부 의존성</a>
<ul class="sectlevel3">
<li><a href="#_authhub">2.3.1. AuthHub</a></li>
<li><a href="#_redis">2.3.2. Redis</a></li>
</ul>
</li>
<li><a href="#architecture-project-structure">2.4. 프로젝트 구조</a></li>
</ul>
</li>
<li><a href="#security">3. 보안</a>
<ul class="sectlevel2">
<li><a href="#security-authentication">3.1. JWT 인증</a>
<ul class="sectlevel3">
<li><a href="#_jwt_claims_구조">3.1.1. JWT Claims 구조</a></li>
</ul>
</li>
<li><a href="#security-rate-limiting">3.2. Rate Limiting</a>
<ul class="sectlevel3">
<li><a href="#_rate_limit_응답_헤더">3.2.1. Rate Limit 응답 헤더</a></li>
</ul>
</li>
<li><a href="#security-multi-tenancy">3.3. Multi-Tenancy</a></li>
</ul>
</li>
<li><a href="#internal-api">4. 내부 관리 API</a>
<ul class="sectlevel2">
<li><a href="#internal-api-actuator">4.1. Actuator APIs</a>
<ul class="sectlevel3">
<li><a href="#internal-api-refresh-public-keys">4.1.1. Public Key Cache 갱신</a></li>
</ul>
</li>
<li><a href="#internal-api-webhooks">4.2. Webhook APIs</a>
<ul class="sectlevel3">
<li><a href="#internal-api-webhooks-permission">4.2.1. Permission Webhooks</a></li>
</ul>
</li>
<li><a href="#internal-api-tenant">4.3. Tenant Config API</a>
<ul class="sectlevel3">
<li><a href="#internal-api-tenant-config-changed">4.3.1. Tenant Config 캐시 무효화</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#api-summary">5. API 요약</a></li>
<li><a href="#http-status-codes">6. HTTP 상태 코드</a></li>
<li><a href="#error-response">7. 에러 응답 형식</a></li>
<li><a href="#appendix">8. 부록</a>
<ul class="sectlevel2">
<li><a href="#appendix-headers">8.1. 요청/응답 헤더</a>
<ul class="sectlevel3">
<li><a href="#_요청_헤더">8.1.1. 요청 헤더</a></li>
<li><a href="#_응답_헤더">8.1.2. 응답 헤더</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="overview"><a class="link" href="#overview">1. 개요</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p><strong>Connectly Gateway</strong>는 마이크로서비스 아키텍처의 API Gateway입니다.</p>
</div>
<div class="paragraph">
<p>Spring Cloud Gateway 기반으로 구축되었으며, 모든 클라이언트 요청이 백엔드 서비스에 도달하기 전에 이 Gateway를 통과합니다.</p>
</div>
<div class="sect2">
<h3 id="_핵심_기능"><a class="link" href="#_핵심_기능">1.1. 핵심 기능</a></h3>
<div class="ulist">
<ul>
<li>
<p><strong>인증 (Authentication)</strong>: JWT 기반 토큰 검증 및 자동 갱신</p>
</li>
<li>
<p><strong>인가 (Authorization)</strong>: 사용자 권한 기반 API 접근 제어</p>
</li>
<li>
<p><strong>Rate Limiting</strong>: IP, Endpoint, User 기반 요청 제한</p>
</li>
<li>
<p><strong>Multi-Tenancy</strong>: 테넌트 격리 및 설정 관리</p>
</li>
<li>
<p><strong>MFA 검증</strong>: 고위험 작업에 대한 2차 인증</p>
</li>
<li>
<p><strong>요청 추적</strong>: 분산 추적을 위한 Trace ID 관리</p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="architecture"><a class="link" href="#architecture">2. 아키텍처</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="architecture-overview"><a class="link" href="#architecture-overview">2.1. 시스템 개요</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">                                    ┌─────────────────────────────────────────────────────────┐
                                    │                   Connectly Gateway                      │
                                    │                                                          │
┌──────────┐     HTTPS              │  ┌─────────────────────────────────────────────────┐   │
│  Client  │ ─────────────────────▶ │  │              Filter Chain                        │   │
│  (App)   │                        │  │                                                   │   │
└──────────┘                        │  │  1. TraceIdFilter                                │   │
                                    │  │  2. RateLimitFilter (IP/Endpoint)                │   │
                                    │  │  3. TokenRefreshFilter                           │   │
                                    │  │  4. JwtAuthenticationFilter                      │   │
                                    │  │  5. UserRateLimitFilter                          │   │
                                    │  │  6. TenantIsolationFilter                        │   │
                                    │  │  7. PermissionFilter                             │   │
                                    │  │  8. MfaVerificationFilter                        │   │
                                    │  │                                                   │   │
                                    │  └──────────────────────┬──────────────────────────┘   │
                                    │                         │                               │
                                    │                         ▼                               │
                                    │  ┌─────────────────────────────────────────────────┐   │
                                    │  │           Route to Backend Services              │   │
                                    │  └─────────────────────────────────────────────────┘   │
                                    │                                                          │
                                    └─────────────────────────────────────────────────────────┘
                                                              │
                          ┌───────────────────────────────────┼───────────────────────────────────┐
                          │                                   │                                   │
                          ▼                                   ▼                                   ▼
                  ┌──────────────┐                    ┌──────────────┐                    ┌──────────────┐
                  │ User Service │                    │Order Service │                    │ Auth Hub     │
                  └──────────────┘                    └──────────────┘                    └──────────────┘</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="architecture-filter-chain"><a class="link" href="#architecture-filter-chain">2.2. Filter Chain</a></h3>
<div class="paragraph">
<p>Gateway의 핵심은 <strong>Filter Chain</strong>입니다. 모든 요청은 순차적으로 Filter를 통과하며, 각 Filter는 특정 보안/기능을 담당합니다.</p>
</div>
<div class="sect3">
<h4 id="_filter_실행_순서"><a class="link" href="#_filter_실행_순서">2.2.1. Filter 실행 순서</a></h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 10%;">
<col style="width: 30%;">
<col style="width: 60%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">순서</th>
<th class="tableblock halign-left valign-top">Filter</th>
<th class="tableblock halign-left valign-top">역할</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">1</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TraceIdFilter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">분산 추적을 위한 Trace ID 생성/전파. MDC에 저장하여 로깅에 활용</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">2</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>RateLimitFilter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>인증 전</strong> Rate Limiting. IP 및 Endpoint 기반 요청 제한. DDoS 방어 1차 방어선</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">3</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TokenRefreshFilter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Token 만료 시 Refresh Token으로 자동 갱신. 클라이언트 투명하게 처리</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">4</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JwtAuthenticationFilter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JWT 토큰 검증 및 Claims 추출. Public Key 기반 서명 검증</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">5</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UserRateLimitFilter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>인증 후</strong> 사용자별 Rate Limiting. JWT에서 userId 추출하여 제한</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">6</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TenantIsolationFilter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Multi-Tenant 환경에서 테넌트 격리. 테넌트 설정 조회 및 헤더 주입</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">7</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PermissionFilter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">RBAC 기반 권한 검사. 사용자 역할과 API 권한 매핑 검증</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">8</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MfaVerificationFilter</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">고위험 엔드포인트에 대한 MFA(2차 인증) 검증</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_filter_동작_흐름"><a class="link" href="#_filter_동작_흐름">2.2.2. Filter 동작 흐름</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">요청 수신
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ TraceIdFilter                                                                    │
│   • X-Trace-Id 헤더 확인 (없으면 생성)                                           │
│   • MDC에 traceId 저장                                                           │
│   • 다음 Filter로 전달                                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ RateLimitFilter                                                                  │
│   • Client IP 추출                                                               │
│   • Redis에서 IP/Endpoint별 카운터 조회                                           │
│   • 제한 초과 시 429 Too Many Requests 반환                                       │
│   • X-RateLimit-* 헤더 추가                                                      │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ TokenRefreshFilter                                                               │
│   • Access Token 만료 여부 확인                                                   │
│   • 만료 시: Refresh Token으로 AuthHub에 토큰 갱신 요청                           │
│   • 새 Access Token을 Authorization 헤더에 설정                                   │
│   • 응답 헤더에 새 토큰 포함 (X-New-Access-Token)                                 │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ JwtAuthenticationFilter                                                          │
│   • Authorization 헤더에서 Bearer 토큰 추출                                       │
│   • Public Key로 JWT 서명 검증                                                    │
│   • Claims 추출 (userId, tenantId, roles 등)                                     │
│   • ServerWebExchange에 인증 정보 저장                                            │
│   • 검증 실패 시 401 Unauthorized 반환                                            │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ UserRateLimitFilter                                                              │
│   • JWT Claims에서 userId 추출                                                   │
│   • 사용자별 Rate Limit 체크                                                      │
│   • OTP 시도 횟수 등 민감 작업 제한                                               │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ TenantIsolationFilter                                                            │
│   • JWT Claims에서 tenantId 추출                                                 │
│   • Redis/AuthHub에서 테넌트 설정 조회                                            │
│   • 테넌트 활성화 상태 검증                                                        │
│   • X-Tenant-Config 헤더로 백엔드에 설정 전달                                     │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ PermissionFilter                                                                 │
│   • 요청 경로 + HTTP Method로 필요 권한 결정                                      │
│   • 사용자 역할(roles)과 권한 매핑 확인                                           │
│   • AuthHub의 Permission Spec과 비교                                             │
│   • 권한 없으면 403 Forbidden 반환                                                │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│ MfaVerificationFilter                                                            │
│   • 고위험 엔드포인트 여부 확인                                                   │
│   • MFA 필요 시 X-MFA-Token 헤더 검증                                            │
│   • 검증 실패 시 403 + MFA 필요 응답                                              │
└─────────────────────────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────────────────────────┐
│                            Backend Service로 라우팅                               │
└─────────────────────────────────────────────────────────────────────────────────┘</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="architecture-external-dependencies"><a class="link" href="#architecture-external-dependencies">2.3. 외부 의존성</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">                        ┌─────────────────┐
                        │ Connectly       │
                        │ Gateway         │
                        └────────┬────────┘
                                 │
          ┌──────────────────────┼──────────────────────┐
          │                      │                      │
          ▼                      ▼                      ▼
   ┌──────────────┐      ┌──────────────┐      ┌──────────────┐
   │   AuthHub    │      │    Redis     │      │  Backend     │
   │              │      │              │      │  Services    │
   │ • JWT Public │      │ • Rate Limit │      │              │
   │   Key 제공    │      │   Counter    │      │ • User       │
   │ • Token 갱신  │      │ • Permission │      │ • Order      │
   │ • Permission │      │   Cache      │      │ • Product    │
   │   Spec 제공   │      │ • Tenant     │      │ • ...        │
   │ • Tenant     │      │   Config     │      │              │
   │   Config     │      │   Cache      │      │              │
   └──────────────┘      └──────────────┘      └──────────────┘</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_authhub"><a class="link" href="#_authhub">2.3.1. AuthHub</a></h4>
<div class="paragraph">
<p>인증/인가 중앙 서버입니다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>JWT Public Key</strong>: JWT 검증용 Public Key 제공</p>
</li>
<li>
<p><strong>Token Refresh</strong>: Refresh Token으로 새 Access Token 발급</p>
</li>
<li>
<p><strong>Permission Spec</strong>: API 권한 명세 제공</p>
</li>
<li>
<p><strong>Tenant Config</strong>: 테넌트별 설정 정보 제공</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_redis"><a class="link" href="#_redis">2.3.2. Redis</a></h4>
<div class="paragraph">
<p>고성능 캐싱 및 카운터 저장소입니다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Rate Limit Counter</strong>: 요청 횟수 카운팅</p>
</li>
<li>
<p><strong>Permission Cache</strong>: 권한 정보 캐시</p>
</li>
<li>
<p><strong>Tenant Config Cache</strong>: 테넌트 설정 캐시</p>
</li>
<li>
<p><strong>Public Key Cache</strong>: JWT Public Key 캐시</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="architecture-project-structure"><a class="link" href="#architecture-project-structure">2.4. 프로젝트 구조</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">adapter-in/gateway/
├── src/main/java/com/ryuqq/gateway/adapter/in/gateway/
│   ├── config/
│   │   └── GatewayFilterOrder.java      # Filter 실행 순서 상수
│   │
│   ├── filter/                          # 핵심 Filter 구현
│   │   ├── TraceIdFilter.java
│   │   ├── RateLimitFilter.java
│   │   ├── TokenRefreshFilter.java
│   │   ├── JwtAuthenticationFilter.java
│   │   ├── UserRateLimitFilter.java
│   │   ├── TenantIsolationFilter.java
│   │   ├── PermissionFilter.java
│   │   └── MfaVerificationFilter.java
│   │
│   ├── controller/                      # 내부 관리 API
│   │   ├── PublicKeyRefreshController.java
│   │   ├── PermissionWebhookController.java
│   │   └── TenantConfigWebhookController.java
│   │
│   ├── error/                           # 에러 처리
│   │   └── JwtErrorHandler.java
│   │
│   ├── common/
│   │   ├── dto/                         # 공통 DTO
│   │   │   ├── ApiResponse.java
│   │   │   └── ErrorInfo.java
│   │   └── util/                        # 유틸리티
│   │       ├── ClientIpExtractor.java
│   │       └── GatewayErrorResponder.java
│   │
│   └── trace/                           # 추적 관련
│       └── TraceIdMdcContext.java
│
└── src/docs/asciidoc/
    └── index.adoc                       # 이 문서</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="security"><a class="link" href="#security">3. 보안</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="security-authentication"><a class="link" href="#security-authentication">3.1. JWT 인증</a></h3>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">┌──────────┐                  ┌─────────────┐                  ┌──────────┐
│  Client  │                  │   Gateway   │                  │ AuthHub  │
└────┬─────┘                  └──────┬──────┘                  └────┬─────┘
     │                               │                              │
     │  1. Request + Bearer Token    │                              │
     │ ─────────────────────────────▶│                              │
     │                               │                              │
     │                               │  2. Get Public Key (cached)  │
     │                               │ ────────────────────────────▶│
     │                               │                              │
     │                               │◀──────────────────────────── │
     │                               │     Public Key               │
     │                               │                              │
     │                               │  3. Verify JWT Signature     │
     │                               │  4. Extract Claims           │
     │                               │  5. Store in Exchange        │
     │                               │                              │
     │  6. Response                  │                              │
     │ ◀─────────────────────────────│                              │
     │                               │                              │</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_jwt_claims_구조"><a class="link" href="#_jwt_claims_구조">3.1.1. JWT Claims 구조</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "sub": "user-123",
  "tenantId": "tenant-abc",
  "roles": ["USER", "ADMIN"],
  "permissions": ["read:users", "write:orders"],
  "iat": 1704067200,
  "exp": 1704070800
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-rate-limiting"><a class="link" href="#security-rate-limiting">3.2. Rate Limiting</a></h3>
<div class="paragraph">
<p>다단계 Rate Limiting으로 시스템을 보호합니다.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 16.6666%;">
<col style="width: 33.3333%;">
<col style="width: 50.0001%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">레벨</th>
<th class="tableblock halign-left valign-top">적용 시점</th>
<th class="tableblock halign-left valign-top">목적</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">IP 기반</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">인증 전 (RateLimitFilter)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">DDoS 방어, 악성 IP 차단</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Endpoint 기반</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">인증 전 (RateLimitFilter)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">특정 API 과부하 방지</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">User 기반</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">인증 후 (UserRateLimitFilter)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">사용자별 공정한 사용 보장</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">OTP 시도</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">인증 후 (UserRateLimitFilter)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Brute Force 공격 방지</p></td>
</tr>
</tbody>
</table>
<div class="sect3">
<h4 id="_rate_limit_응답_헤더"><a class="link" href="#_rate_limit_응답_헤더">3.2.1. Rate Limit 응답 헤더</a></h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">X-RateLimit-Limit: 100
X-RateLimit-Remaining: 95
X-RateLimit-Reset: 1704067260</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="security-multi-tenancy"><a class="link" href="#security-multi-tenancy">3.3. Multi-Tenancy</a></h3>
<div class="paragraph">
<p>테넌트 격리를 통해 데이터 보안을 보장합니다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">요청 → JWT에서 tenantId 추출 → 테넌트 설정 조회 → 테넌트 활성화 검증
                                      │
                                      ▼
                              X-Tenant-Config 헤더로
                              백엔드 서비스에 전달</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="internal-api"><a class="link" href="#internal-api">4. 내부 관리 API</a></h2>
<div class="sectionbody">
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>이 API들은 <strong>내부 시스템 전용</strong>입니다.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>외부에서 직접 호출하면 안 됩니다</p>
</li>
<li>
<p>IP Whitelist 또는 내부 네트워크에서만 접근 가능해야 합니다</p>
</li>
<li>
<p>AuthHub와 같은 내부 서비스에서 Webhook으로 호출됩니다</p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="internal-api-actuator"><a class="link" href="#internal-api-actuator">4.1. Actuator APIs</a></h3>
<div class="sect3">
<h4 id="internal-api-refresh-public-keys"><a class="link" href="#internal-api-refresh-public-keys">4.1.1. Public Key Cache 갱신</a></h4>
<div class="paragraph">
<p>JWT 검증을 위한 Public Key 캐시를 갱신합니다.</p>
</div>
<div class="paragraph">
<p>AuthHub의 Public Key가 변경되었을 때 호출합니다.</p>
</div>
<div class="sect4">
<h5 id="_request"><a class="link" href="#_request">Request</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ curl 'http://localhost:8080/actuator/refresh-public-keys' -i -X POST \
    -H 'Content-Type: application/json'</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_response"><a class="link" href="#_response">Response</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-http hljs" data-lang="http">HTTP/1.1 200 OK</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="internal-api-webhooks"><a class="link" href="#internal-api-webhooks">4.2. Webhook APIs</a></h3>
<div class="paragraph">
<p>AuthHub로부터 호출되는 Webhook 엔드포인트입니다.</p>
</div>
<div class="sect3">
<h4 id="internal-api-webhooks-permission"><a class="link" href="#internal-api-webhooks-permission">4.2.1. Permission Webhooks</a></h4>
<div class="sect4">
<h5 id="internal-api-webhooks-permission-spec-sync"><a class="link" href="#internal-api-webhooks-permission-spec-sync">Permission Spec 동기화</a></h5>
<div class="paragraph">
<p>Permission Spec 캐시를 무효화합니다.</p>
</div>
<div class="paragraph">
<p>AuthHub에서 권한 명세가 변경되었을 때 호출됩니다.</p>
</div>
<div class="sect5">
<h6 id="_request_2"><a class="link" href="#_request_2">Request</a></h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ curl 'http://localhost:8080/webhooks/permission/spec-sync' -i -X POST \
    -H 'Content-Type: application/json' \
    -d '{
  "version" : 123,
  "changedServices" : [ "user-service", "order-service" ]
}'</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_request_fields"><a class="link" href="#_request_fields">Request Fields</a></h6>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>version</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission Spec 버전</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>changedServices</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Array</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">변경된 서비스 목록</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="_response_2"><a class="link" href="#_response_2">Response</a></h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-http hljs" data-lang="http">HTTP/1.1 200 OK</code></pre>
</div>
</div>
</div>
</div>
<div class="sect4">
<h5 id="internal-api-webhooks-permission-user-invalidate"><a class="link" href="#internal-api-webhooks-permission-user-invalidate">사용자 권한 캐시 무효화</a></h5>
<div class="paragraph">
<p>특정 사용자의 Permission Hash 캐시를 무효화합니다.</p>
</div>
<div class="paragraph">
<p>사용자의 역할이나 권한이 변경되었을 때 호출됩니다.</p>
</div>
<div class="sect5">
<h6 id="_request_3"><a class="link" href="#_request_3">Request</a></h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ curl 'http://localhost:8080/webhooks/permission/user-invalidate' -i -X POST \
    -H 'Content-Type: application/json' \
    -d '{
  "tenantId" : "tenant-123",
  "userId" : "user-456"
}'</code></pre>
</div>
</div>
</div>
<div class="sect5">
<h6 id="_request_fields_2"><a class="link" href="#_request_fields_2">Request Fields</a></h6>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tenantId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">테넌트 ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>userId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">사용자 ID</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect5">
<h6 id="_response_3"><a class="link" href="#_response_3">Response</a></h6>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-http hljs" data-lang="http">HTTP/1.1 200 OK</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="internal-api-tenant"><a class="link" href="#internal-api-tenant">4.3. Tenant Config API</a></h3>
<div class="sect3">
<h4 id="internal-api-tenant-config-changed"><a class="link" href="#internal-api-tenant-config-changed">4.3.1. Tenant Config 캐시 무효화</a></h4>
<div class="paragraph">
<p>Tenant Config 캐시를 무효화합니다.</p>
</div>
<div class="paragraph">
<p>AuthHub에서 테넌트 설정이 변경되었을 때 호출됩니다.</p>
</div>
<div class="sect4">
<h5 id="_request_4"><a class="link" href="#_request_4">Request</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">$ curl 'http://localhost:8080/internal/gateway/tenants/config-changed' -i -X POST \
    -H 'Content-Type: application/json' \
    -d '{
  "tenantId" : "tenant-abc-123",
  "timestamp" : 1.736937E9
}'</code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_request_fields_3"><a class="link" href="#_request_fields_3">Request Fields</a></h5>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Path</th>
<th class="tableblock halign-left valign-top">Type</th>
<th class="tableblock halign-left valign-top">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>tenantId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">변경된 테넌트 ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>timestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Number</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">변경 시각 (Unix timestamp)</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect4">
<h5 id="_response_4"><a class="link" href="#_response_4">Response</a></h5>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight nowrap"><code class="language-http hljs" data-lang="http">HTTP/1.1 200 OK</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="api-summary"><a class="link" href="#api-summary">5. API 요약</a></h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 12.5%;">
<col style="width: 37.5%;">
<col style="width: 50%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Method</th>
<th class="tableblock halign-left valign-top">Endpoint</th>
<th class="tableblock halign-left valign-top">설명</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/actuator/refresh-public-keys</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Public Key 캐시 갱신</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/webhooks/permission/spec-sync</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Permission Spec 캐시 무효화</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/webhooks/permission/user-invalidate</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">사용자 권한 캐시 무효화</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>POST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>/internal/gateway/tenants/config-changed</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tenant Config 캐시 무효화</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="http-status-codes"><a class="link" href="#http-status-codes">6. HTTP 상태 코드</a></h2>
<div class="sectionbody">
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">상태 코드</th>
<th class="tableblock halign-left valign-top">설명</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>200 OK</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">요청 성공</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>401 Unauthorized</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">인증 실패 (JWT 없음, 만료, 유효하지 않음)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>403 Forbidden</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">권한 없음 (인증은 됐으나 접근 권한 없음)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>429 Too Many Requests</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rate Limit 초과</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>500 Internal Server Error</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">서버 내부 오류</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="sect1">
<h2 id="error-response"><a class="link" href="#error-response">7. 에러 응답 형식</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>모든 에러는 다음 형식으로 반환됩니다.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-json hljs" data-lang="json">{
  "success": false,
  "data": null,
  "error": {
    "code": "AUTH_001",
    "message": "Invalid or expired token"
  }
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="appendix"><a class="link" href="#appendix">8. 부록</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="appendix-headers"><a class="link" href="#appendix-headers">8.1. 요청/응답 헤더</a></h3>
<div class="sect3">
<h4 id="_요청_헤더"><a class="link" href="#_요청_헤더">8.1.1. 요청 헤더</a></h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 28.5714%;">
<col style="width: 14.2857%;">
<col style="width: 57.1429%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">헤더</th>
<th class="tableblock halign-left valign-top">필수</th>
<th class="tableblock halign-left valign-top">설명</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Authorization</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">O</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Bearer {access_token} 형식의 JWT</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-Trace-Id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">분산 추적용 ID (없으면 자동 생성)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-Refresh-Token</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Access Token 만료 시 갱신용</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-MFA-Token</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">X</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">MFA 검증이 필요한 요청에 사용</p></td>
</tr>
</tbody>
</table>
</div>
<div class="sect3">
<h4 id="_응답_헤더"><a class="link" href="#_응답_헤더">8.1.2. 응답 헤더</a></h4>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">헤더</th>
<th class="tableblock halign-left valign-top">설명</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-Trace-Id</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">요청 추적용 ID</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-RateLimit-Limit</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rate Limit 최대 요청 수</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-RateLimit-Remaining</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">남은 요청 수</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-RateLimit-Reset</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Rate Limit 리셋 시각 (Unix timestamp)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>X-New-Access-Token</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Token 갱신 시 새 Access Token</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0.0-SNAPSHOT<br>
Last updated 2026-02-02 09:40:50 +0900
</div>
</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.3/highlight.min.js"></script>
<script>
if (!hljs.initHighlighting.called) {
  hljs.initHighlighting.called = true
  ;[].slice.call(document.querySelectorAll('pre.highlight > code[data-lang]')).forEach(function (el) { hljs.highlightBlock(el) })
}
</script>
</body>
</html>