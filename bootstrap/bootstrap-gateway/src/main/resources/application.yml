# ===============================================
# Connectly Gateway Application Configuration
# ===============================================
# Spring Cloud Gateway + Redis + JWT Authentication
# Zero-Trust API Gateway with AWS Cloud Map Service Discovery
#
# @since 1.0.0
# ===============================================

# ===============================================
# Server Configuration (Netty - Reactive)
# ===============================================
server:
  port: 8080

# ===============================================
# Spring Configuration
# ===============================================
spring:
  application:
    name: connectly-gateway

  # Profile
  profiles:
    active: local

  # Import additional configuration files
  config:
    import:
      - classpath:authhub-client.yml

  # ===============================================
  # Cloud Gateway
  # ===============================================
  cloud:
    gateway:
      # Global CORS Configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: "*"
            allowed-methods: "*"
            allowed-headers: "*"

      # Routes (configured programmatically in GatewayRoutingConfig)
      routes: []

  # ===============================================
  # Redis (Public Key Cache)
  # ===============================================
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      timeout: 3s
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2

# ===============================================
# AuthHub Client Configuration (JWKS Endpoint)
# ===============================================
authhub:
  client:
    base-url: ${AUTHHUB_BASE_URL:http://localhost:8080}
    jwks-endpoint: /api/v1/auth/jwks
    timeout:
      connection: 3000
      response: 3000
    retry:
      max-attempts: 3
      wait-duration: 100
    circuit-breaker:
      failure-rate-threshold: 50
      wait-duration-in-open-state: 10000
      sliding-window-size: 10
      minimum-number-of-calls: 5

# ===============================================
# JWT Configuration
# ===============================================
jwt:
  public-key-cache-ttl: 3600  # 1 hour (seconds)

# ===============================================
# Gateway Routing Configuration
# ===============================================
# Convention-based routing with AWS Cloud Map Service Discovery
#
# Routing Strategy:
#   - discovery.enabled=true: http://{service-id}.{namespace}:{port}
#   - discovery.enabled=false: use static 'uri' from configuration
#
# Public Endpoints (no JWT required):
#   - Defined in each service's 'public-paths' list
# ===============================================
gateway:
  routing:
    discovery:
      enabled: false
      namespace: connectly.local
      default-port: 8080

    services:
      # ============================================
      # AuthHub Service
      # ============================================
      - id: authhub
        uri: ${AUTH_HUB_URL:http://localhost:8080}
        port: 8080
        paths:
          - /api/v1/auth/**
          - /api/v1/tenants/**
          - /api/v1/organizations/**
          - /api/v1/users/**
          - /api/v1/roles/**
          - /api/v1/permissions/**
        public-paths:
          - /api/v1/auth/login
          - /api/v1/auth/refresh
          - /api/v1/auth/logout
          - /api/v1/auth/.well-known/**
          - /api/v1/auth/jwks

      # ============================================
      # FileFlow Service
      # ============================================
      - id: fileflow
        uri: ${FILEFLOW_URI:http://localhost:8082}
        paths:
          - /api/v1/file/**
        public-paths: []

      # ============================================
      # Commerce Service
      # ============================================
      - id: commerce
        uri: ${COMMERCE_URI:http://localhost:8081}
        paths:
          - /api/v1/commerce/**
          - /api/v1/order/**
          - /api/v1/product/**
        public-paths: []

      # ============================================
      # CrawlingHub Service
      # ============================================
      - id: crawling
        uri: ${CRAWLING_URI:http://localhost:8083}
        paths:
          - /api/v1/crawling/**
        public-paths: []

      # ============================================
      # MarketPlace Service
      # ============================================
      - id: marketplace
        uri: ${MARKETPLACE_URI:http://localhost:8084}
        paths:
          - /api/v1/marketplace/**
        public-paths: []

    # Host-based routing mapping (for production)
    host-mapping:
      api.set-of.com: public
      admin.set-of.com: admin

# ===============================================
# Management & Actuator
# ===============================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,refresh-public-keys
      base-path: /actuator

  endpoint:
    health:
      show-details: when-authorized

  metrics:
    export:
      prometheus:
        enabled: true

# ===============================================
# Logging
# ===============================================
logging:
  level:
    root: INFO
    com.ryuqq.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web.reactive: DEBUG

  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ===============================================
# Profile-Specific Configurations
# ===============================================

---
# ===============================================
# Local Environment
# ===============================================
spring:
  config:
    activate:
      on-profile: local

gateway:
  routing:
    discovery:
      enabled: false  # Use static URI
    services:
      - id: authhub
        uri: ${AUTH_HUB_URL:http://localhost:8080}
        port: 8080
        paths:
          - /api/v1/auth/**
          - /api/v1/tenants/**
          - /api/v1/organizations/**
          - /api/v1/users/**
          - /api/v1/roles/**
          - /api/v1/permissions/**
        public-paths:
          - /api/v1/auth/login
          - /api/v1/auth/refresh
          - /api/v1/auth/logout
          - /api/v1/auth/.well-known/**
          - /api/v1/auth/jwks

logging:
  level:
    root: DEBUG
    com.ryuqq.gateway: TRACE

---
# ===============================================
# Test Environment
# ===============================================
spring:
  config:
    activate:
      on-profile: test

gateway:
  routing:
    discovery:
      enabled: false

logging:
  level:
    root: INFO
    com.ryuqq.gateway: DEBUG

---
# ===============================================
# Production Environment (AWS ECS + Cloud Map)
# ===============================================
spring:
  config:
    activate:
      on-profile: prod

# Redis
spring.data.redis:
  host: ${REDIS_HOST}
  port: ${REDIS_PORT:6379}

# AuthHub Client (Cloud Map DNS)
authhub:
  client:
    base-url: http://authhub-web-api-prod.connectly.local:8080

# Gateway Routing with Cloud Map Service Discovery
gateway:
  routing:
    discovery:
      enabled: true  # Enable Cloud Map DNS resolution
      namespace: connectly.local
      default-port: 8080

    services:
      # AuthHub Service (port 8080)
      - id: authhub
        uri: http://authhub-web-api-prod.connectly.local:8080
        port: 8080
        paths:
          - /api/v1/auth/**
          - /api/v1/tenants/**
          - /api/v1/organizations/**
          - /api/v1/users/**
          - /api/v1/roles/**
          - /api/v1/permissions/**
        public-paths:
          - /api/v1/auth/login
          - /api/v1/auth/refresh
          - /api/v1/auth/logout
          - /api/v1/auth/.well-known/**
          - /api/v1/auth/jwks

      # FileFlow Service
      - id: fileflow
        paths:
          - /api/v1/file/**

      # Commerce Service
      - id: commerce
        paths:
          - /api/v1/commerce/**
          - /api/v1/order/**
          - /api/v1/product/**

      # CrawlingHub Service
      - id: crawling
        paths:
          - /api/v1/crawling/**

      # MarketPlace Service
      - id: marketplace
        paths:
          - /api/v1/marketplace/**

    host-mapping:
      api.set-of.com: public
      admin.set-of.com: admin

logging:
  level:
    root: WARN
    com.ryuqq.gateway: INFO
    org.springframework.cloud.gateway: INFO
