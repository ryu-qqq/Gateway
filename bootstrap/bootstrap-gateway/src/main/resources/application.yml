# ===============================================
# Connectly Gateway Application Configuration
# ===============================================
# Spring Cloud Gateway + Redis + JWT Authentication
# Zero-Trust API Gateway with AWS Cloud Map Service Discovery
#
# @since 1.0.0
# ===============================================

# ===============================================
# Server Configuration (Netty - Reactive)
# ===============================================
server:
  port: 8080
  # CloudFront/ALB에서 전달하는 X-Forwarded-* 헤더 처리
  # X-Forwarded-Host를 사용하여 원본 호스트 기반 라우팅 지원
  forward-headers-strategy: framework

# ===============================================
# Spring Configuration
# ===============================================
spring:
  application:
    name: connectly-gateway

  # Profile
  profiles:
    active: local

  # Import additional configuration files
  config:
    import:
      - classpath:authhub-client.yml

  # ===============================================
  # Cloud Gateway
  # ===============================================
  cloud:
    gateway:
      # Global CORS Configuration
      globalcors:
        cors-configurations:
          '[/**]':
            allowed-origins: "*"
            allowed-methods: "*"
            allowed-headers: "*"

      # Routes (configured programmatically in GatewayRoutingConfig)
      routes: []

  # ===============================================
  # Redis (Public Key Cache)
  # ===============================================
  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      timeout: 3s
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2

# ===============================================
# AuthHub Client Configuration (JWKS Endpoint)
# ===============================================
authhub:
  client:
    base-url: ${AUTHHUB_BASE_URL:http://localhost:8080}
    jwks-endpoint: /api/v1/auth/jwks
    timeout:
      connection: 3000
      response: 3000
    retry:
      max-attempts: 3
      wait-duration: 100
    circuit-breaker:
      failure-rate-threshold: 50
      wait-duration-in-open-state: 10000
      sliding-window-size: 10
      minimum-number-of-calls: 5

# ===============================================
# JWT Configuration
# ===============================================
jwt:
  public-key-cache-ttl: 3600  # 1 hour (seconds)

# ===============================================
# Gateway Routing Configuration
# ===============================================
# Convention-based routing with AWS Cloud Map Service Discovery
#
# Routing Strategy:
#   - discovery.enabled=true: http://{service-id}.{namespace}:{port}
#   - discovery.enabled=false: use static 'uri' from configuration
#
# Public Endpoints (no JWT required):
#   - Defined in each service's 'public-paths' list
# ===============================================
gateway:
  # ===============================================
  # Rate Limit Configuration
  # ===============================================
  # IP/USER: 500 req/min, ENDPOINT: 1000 req/min
  # AWS 환경에서 X-Forwarded-For 헤더 기반 IP 추출
  rate-limit:
    enabled: true
    ip-limit: 500        # IP당 분당 요청 제한 (기본 100 → 500)
    user-limit: 500      # 사용자당 분당 요청 제한 (기본 100 → 500)
    endpoint-limit: 1000 # 엔드포인트당 분당 요청 제한 (기본값 유지)

  routing:
    discovery:
      enabled: false
      namespace: connectly.local
      default-port: 8080

    services:
      # ============================================
      # AuthHub Service
      # ============================================
      - id: authhub
        uri: ${AUTH_HUB_URL:http://localhost:8080}
        port: 8080
        paths:
          - /api/v1/auth/**
        public-paths:
          - /api/v1/auth/login
          - /api/v1/auth/refresh
          - /api/v1/auth/logout
          - /api/v1/auth/.well-known/**
          - /api/v1/auth/jwks

      # ============================================
      # MarketPlace Service
      # ============================================
      - id: marketplace
        uri: ${MARKETPLACE_URI:http://localhost:9090}
        port: 9090
        paths:
          - /api/v1/market/**
        public-paths:
          - /api/v1/market/swagger-ui/**
          - /api/v1/market/swagger-ui.html
          - /api/v1/market/api-docs/**
          - /api/v1/market/docs/**

      # ============================================
      # Commerce Service
      # ============================================
      - id: commerce
        uri: ${COMMERCE_URI:http://localhost:8081}
        paths:
          - /api/v1/commerce/**
        public-paths: []

      # ============================================
      # FileFlow Service
      # ============================================
      - id: fileflow
        uri: ${FILEFLOW_URI:http://localhost:8082}
        paths:
          - /api/v1/file/**
        public-paths: []

      # ============================================
      # CrawlingHub Service
      # ============================================
      - id: crawling
        uri: ${CRAWLING_URI:http://localhost:8083}
        paths:
          - /api/v1/crawling/**
        public-paths: []

    # Host-based routing mapping (for production)
    host-mapping:
      api.set-of.com: public
      admin.set-of.com: admin

# ===============================================
# Observability (TraceId + MDC Context Propagation)
# ===============================================
# MdcContextLifterHook으로 Reactor Context → MDC 자동 전파
# 기존 TraceIdFilter(GlobalFilter)는 X-Trace-Id 헤더 존재 시 재사용
observability:
  reactive-trace:
    enabled: true
    generate-if-missing: true  # traceId 없으면 생성 (필터 체인 진행 필수)

# ===============================================
# Sentry (Error Tracking)
# ===============================================
# DSN은 환경변수로 주입 (Secrets Manager / SSM Parameter)
sentry:
  dsn: ${SENTRY_DSN:}
  environment: ${spring.profiles.active:local}
  release: ${APP_VERSION:unknown}
  # 성능 모니터링 (트랜잭션 샘플링)
  traces-sample-rate: 0.1  # 프로덕션: 10% 샘플링
  # 민감 정보 필터링
  send-default-pii: false
  # 서버 이름 (ECS Task ID 사용)
  server-name: ${HOSTNAME:unknown}
  # 에러 필터링
  ignored-exceptions-for-type:
    - org.springframework.web.server.ResponseStatusException
  # 로그 연동
  logging:
    minimum-event-level: error    # ERROR 이상만 Sentry로 전송
    minimum-breadcrumb-level: info # INFO 이상은 breadcrumb으로 저장

# ===============================================
# Management & Actuator
# ===============================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,prometheus,refresh-public-keys
      base-path: /actuator

  endpoint:
    health:
      show-details: when-authorized

  metrics:
    tags:
      application: ${spring.application.name}
      environment: ${spring.profiles.active:local}
    distribution:
      percentiles-histogram:
        http.server.requests: true
      percentiles:
        http.server.requests: 0.5,0.95,0.99
      slo:
        http.server.requests: 100ms,500ms,1s,5s
    export:
      prometheus:
        enabled: true

# ===============================================
# Logging
# ===============================================
logging:
  level:
    root: INFO
    com.ryuqq.gateway: DEBUG
    org.springframework.cloud.gateway: DEBUG
    org.springframework.web.reactive: DEBUG

  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n"

# ===============================================
# Profile-Specific Configurations
# ===============================================

---
# ===============================================
# Local Environment
# ===============================================
spring:
  config:
    activate:
      on-profile: local

# gateway.routing.services는 기본 설정(라인 109-160)을 그대로 사용
# discovery.enabled=false가 기본값이므로 static URI 사용됨

logging:
  level:
    root: DEBUG
    com.ryuqq.gateway: TRACE

---
# ===============================================
# Test Environment
# ===============================================
spring:
  config:
    activate:
      on-profile: test

gateway:
  routing:
    discovery:
      enabled: false

logging:
  level:
    root: INFO
    com.ryuqq.gateway: DEBUG

---
# ===============================================
# Production Environment (AWS ECS + Cloud Map)
# ===============================================
spring:
  config:
    activate:
      on-profile: prod

# Redis
spring.data.redis:
  host: ${REDIS_HOST}
  port: ${REDIS_PORT:6379}

# AuthHub Client (Cloud Map DNS)
authhub:
  client:
    base-url: http://authhub-web-api-prod.connectly.local:8080

# Gateway Routing with Cloud Map Service Discovery
gateway:
  routing:
    discovery:
      enabled: true  # Enable Cloud Map DNS resolution
      namespace: connectly.local
      default-port: 8080

    services:
      # AuthHub Service (port 8080)
      - id: authhub
        uri: http://authhub-web-api-prod.connectly.local:8080
        port: 8080
        paths:
          - /api/v1/auth/**
        public-paths:
          - /api/v1/auth/login
          - /api/v1/auth/refresh
          - /api/v1/auth/logout
          - /api/v1/auth/.well-known/**
          - /api/v1/auth/jwks

      # FileFlow Service
      - id: fileflow
        uri: http://fileflow-web-api-prod.connectly.local:8080
        paths:
          - /api/v1/file/**

      # Commerce Service
      - id: commerce
        uri: http://commerce-web-api-prod.connectly.local:8080
        paths:
          - /api/v1/commerce/**

      # CrawlingHub Service
      - id: crawling
        uri: http://crawlinghub-web-api-prod.connectly.local:8080
        paths:
          - /api/v1/crawling/**

      # MarketPlace Service
      - id: marketplace
        uri: http://marketplace-web-api-prod.connectly.local:9090
        port: 9090
        paths:
          - /api/v1/market/**

      # ============================================
      # Legacy Web API Service (Host-based routing)
      # Handles: www.set-of.com, stage.set-of.com, set-of.com, server.set-of.net
      # ============================================
      - id: legacy-web
        uri: ${LEGACY_WEB_URI:http://setof-commerce-legacy-api-prod.connectly.local:8088}
        paths:
          - /**
        hosts:
          - www.set-of.com
          - stage.set-of.com
          - set-of.com
          - server.set-of.net
        public-paths:
          - /**

      # ============================================
      # Legacy Admin API Service (Host-based routing)
      # Handles: admin.set-of.com, admin-server.set-of.net
      # ============================================
      - id: legacy-admin
        uri: ${LEGACY_ADMIN_URI:http://setof-commerce-legacy-admin-prod.connectly.local:8089}
        paths:
          - /**
        hosts:
          - admin.set-of.com
          - admin-server.set-of.net
        public-paths:
          - /**

    host-mapping:
      api.set-of.com: public
      admin.set-of.com: admin

logging:
  level:
    root: WARN
    com.ryuqq.gateway: INFO
    org.springframework.cloud.gateway: INFO
