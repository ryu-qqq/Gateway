# ===============================================
# Stage Environment Configuration
# ===============================================
# 스테이징 환경 전용 설정
# 공통 설정은 application.yml 참조
#
# Stage에서는 공유 Redis 사용 (/shared/stage/elasticache/*)
#
# @author Development Team
# @since 1.0.0
# ===============================================

spring:
  config:
    import:
      - classpath:redis.yml
      - classpath:redis-stage.yml

  # Redis (Shared Stage Redis)
  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      timeout: 3s

# ===============================================
# Sentry (Enabled for Stage)
# ===============================================
# DSN은 환경변수로 주입 (SSM Parameter: /gateway/sentry/dsn)
# 노이즈 필터링: SentryConfig.java의 BeforeSendCallback 참조
sentry:
  dsn: ${SENTRY_DSN}
  environment: stage
  release: ${APP_VERSION:unknown}
  # 성능 모니터링 (트랜잭션 샘플링)
  traces-sample-rate: 0.1
  # 민감 정보 필터링
  send-default-pii: false
  # 서버 이름 (ECS Task ID 사용)
  server-name: ${HOSTNAME:unknown}
  # 에러 필터링 (예외 타입 기반)
  # 추가 필터링은 SentryConfig.java의 BeforeSendCallback에서 처리
  ignored-exceptions-for-type:
    - org.springframework.web.server.ResponseStatusException
  # 로그 연동
  logging:
    minimum-event-level: error    # ERROR 이상만 Sentry로 전송
    minimum-breadcrumb-level: info # INFO 이상은 breadcrumb으로 저장

# ===============================================
# Gateway Routing (Stage Cloud Map Service Discovery)
# ===============================================
# discovery.enabled, host-mapping은 gateway.yml에서 프로파일별 설정
gateway:
  # Stage 환경에서는 IP 차단 기능 비활성화
  rate-limit:
    ip-block-enabled: false
  routing:
    services:
      # ============================================
      # Host-based Routes (MUST be registered FIRST)
      # 호스트 기반 라우트는 path 기반 라우트보다 먼저 등록되어야 함
      # ============================================

      # ============================================
      # New Web API v2 (Strangler Fig Pattern)
      # /api/v2/** 경로만 새 서비스로 라우팅
      # 반드시 legacy-web보다 먼저 등록되어야 함!
      # NOTE: 인증은 downstream 서비스에서 처리
      # ============================================
      - id: new-web-v2
        uri: ${NEW_WEB_URI:http://setof-commerce-web-api-stage.connectly.local:8080}
        paths:
          - /api/v2/**
        hosts:
          - stage.set-of.com
        public-paths:
          - /api/v2/**

      # Legacy Web API Service (Host-based routing)
      # Handles: stage.set-of.com
      # Strangler Fig Pattern: v2 외 모든 경로는 레거시로 라우팅
      - id: legacy-web
        uri: ${LEGACY_WEB_URI:http://setof-commerce-legacy-api-stage.connectly.local:8088}
        paths:
          - /**
        hosts:
          - stage.set-of.com
        public-paths:
          - /**

      # ============================================
      # New Admin API v2 (Strangler Fig Pattern)
      # /api/v2/** 경로만 새 서비스로 라우팅
      # 반드시 legacy-admin보다 먼저 등록되어야 함!
      # NOTE: 인증은 downstream 서비스에서 처리
      # ============================================
      - id: new-admin-v2
        uri: ${NEW_ADMIN_URI:http://setof-commerce-web-api-admin-stage.connectly.local:8081}
        paths:
          - /api/v2/**
        hosts:
          - stage-admin.set-of.com
        public-paths:
          - /api/v2/**

      # Legacy Admin API Service (Host-based routing)
      # Handles: stage-admin.set-of.com
      # Strangler Fig Pattern: v2 외 모든 경로는 레거시로 라우팅
      - id: legacy-admin
        uri: ${LEGACY_ADMIN_URI:http://setof-commerce-legacy-admin-stage.connectly.local:8089}
        paths:
          - /**
        hosts:
          - stage-admin.set-of.com
        public-paths:
          - /**

      # ============================================
      # Path-based Routes (API Gateway services)
      # ============================================

      # AuthHub Service (port 8080)
      - id: authhub
        uri: http://authhub-web-api-stage.connectly.local:8080
        port: 8080
        paths:
          - /api/v1/auth/**
        public-paths:
          - /api/v1/auth/login
          - /api/v1/auth/refresh
          - /api/v1/auth/logout
          - /api/v1/auth/.well-known/**
          - /api/v1/auth/jwks

      # FileFlow Service
      - id: fileflow
        uri: http://fileflow-web-api-stage.connectly.local:8080
        paths:
          - /api/v1/file/**

      # Commerce Service
      - id: commerce
        uri: http://commerce-web-api-stage.connectly.local:8080
        paths:
          - /api/v1/commerce/**

      # CrawlingHub Service
      - id: crawling
        uri: http://crawlinghub-web-api-stage.connectly.local:8080
        paths:
          - /api/v1/crawling/**

      # MarketPlace Service
      - id: marketplace
        uri: http://marketplace-api-stage.connectly.local:8080
        port: 8080
        paths:
          - /api/v1/market/**
        public-paths:
          - /api/v1/market/auth/login
          - /api/v1/market/auth/refresh

      # Template Service
      - id: template
        uri: http://spring-template-web-api-stage.connectly.local:8080
        paths:
          - /api/v1/templates/**
        public-paths:
          - /api/v1/templates/**

# ===============================================
# Logging (Stage: INFO)
# ===============================================
logging:
  level:
    root: INFO
    com.ryuqq.gateway: DEBUG
